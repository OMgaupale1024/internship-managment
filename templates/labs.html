{% extends 'layout.html' %}
{% block content %}
  <div class="d-flex justify-content-between mb-3">
    <h3>Course Labs & SQL Examples</h3>
    <small class="text-muted">Run safe SELECT/SHOW queries from here to explore advanced SQL</small>
  </div>

  <div class="row">
    <div class="col-md-6">
      <div class="card mb-3 highlight-card">
        <div class="card-body">
          <h5 class="card-title">Course Topics</h5>
          <ul>
            <li>DDL — CREATE, ALTER, DROP (use MySQL Workbench or SQL files provided)</li>
            <li>DML — INSERT, UPDATE, DELETE (demo queries included)</li>
            <li>DCL — GRANT/REVOKE examples (requires proper privileges)</li>
            <li>Advanced SQL — JOINs, GROUP BY, window functions (MySQL 8+), aggregates</li>
            <li>Stored routines — MySQL stored procedures (MySQL uses stored procedures; PL/SQL is Oracle specific)</li>
          </ul>
          <p class="mb-0"><strong>Note:</strong> For DDL/DML/DCL that modify the schema or data use MySQL Workbench or run SQL scripts locally. The UI here only allows safe read-only queries (SELECT/SHOW/EXPLAIN).</p>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <h6>Sample advanced query</h6>
          <pre class="small">{{ examples['advanced_join'] }}</pre>
          <button class="btn btn-sm btn-outline-primary" onclick="runQuery(`{{ examples['advanced_join'] }}`)">Run</button>
          <button class="btn btn-sm btn-outline-secondary ms-2" onclick="openDbModal()">View Database</button>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-body">
          <h6>Run a read-only SQL (SELECT/SHOW/EXPLAIN)</h6>
          <textarea id="sqlInput" class="form-control mb-2" rows="5">SELECT * FROM students LIMIT 10;</textarea>
          <div class="d-flex">
            <button class="btn btn-primary me-2" onclick="runQuery(document.getElementById('sqlInput').value)">Run Query</button>
            <button class="btn btn-outline-secondary" onclick="document.getElementById('sqlInput').value = ''">Clear</button>
          </div>
          <div id="queryResult" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h5 class="card-title">SQL files for Workbench</h5>
      <p>Use these SQL files in MySQL Workbench to practice DDL/DML/DCL and stored routines:</p>
      <ul>
        <li><a href="/static/sql/db_init.sql" target="_blank">db_init.sql</a> — creates schema and sample data.</li>
        <li><a href="/static/sql/sample_ddls.sql" target="_blank">sample_ddls.sql</a> — DDL examples (create/alter/drop).</li>
        <li><a href="/static/sql/sample_dmls.sql" target="_blank">sample_dmls.sql</a> — DML examples (insert/update/delete).</li>
        <li><a href="/static/sql/sample_procs.sql" target="_blank">sample_procs.sql</a> — stored procedures examples (MySQL).</li>
      </ul>
    </div>
  </div>

  <script>
    async function openDbModal(){
      const modalEl = document.getElementById('dbModal');
      const bs = new bootstrap.Modal(modalEl);
      document.getElementById('dbModalBody').innerHTML = 'Loading...';
      bs.show();
      const res = await fetch('/api/db_overview');
      const json = await res.json();
      if(json.status !== 'ok'){
        document.getElementById('dbModalBody').innerHTML = '<div class="alert alert-danger">'+(json.message||'Failed to load')+'</div>';
        return;
      }
      const tables = json.tables;
      let html = '<div class="list-group">';
      for(const t of tables){
        html += `<a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start" data-table="${t.table}" onclick="loadTableSample(event, '${t.table}')"><div><div class=\"fw-bold\">${t.table}</div><small class=\"text-muted\">${t.columns.length} columns • approx ${t.rows} rows</small></div><div><button class=\"btn btn-sm btn-outline-primary\">View</button></div></a>`;
      }
      html += '</div><div id="tableInspector" class="mt-3"></div>';
      document.getElementById('dbModalBody').innerHTML = html;
    }

    async function loadTableSample(e, table){
      e.preventDefault();
      const inspector = document.getElementById('tableInspector');
      inspector.innerHTML = '<div>Loading table...</div>';
      const res = await fetch(`/api/table_sample/${encodeURIComponent(table)}?limit=10`);
      const json = await res.json();
      if(json.status !== 'ok'){
        inspector.innerHTML = '<div class="alert alert-danger">'+(json.message||'Failed to load')+'</div>';
        return;
      }
      const rows = json.rows;
      if(rows.length === 0){ inspector.innerHTML = '<div class="alert alert-info">No rows</div>'; return; }
      const cols = Object.keys(rows[0]);
      let html = '<div class="d-flex justify-content-between mb-2"><h6>'+table+'</h6><div><a class="btn btn-sm btn-outline-success me-2" href="/api/table_export/'+encodeURIComponent(table)+'">Export CSV</a><button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById(\'dbModal\').querySelector(\'#tableInspector\').innerHTML=\'\'">Close</button></div></div>';
      html += '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>' + rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]===null?'NULL':String(r[c])}</td>`).join('')+'</tr>').join('') + '</tbody></table></div>';
      inspector.innerHTML = html;
    }

    async function runQuery(q){
      document.getElementById('queryResult').innerHTML = 'Running...';
      const res = await fetch('/api/query', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({query: q})});
      const json = await res.json();
      if(json.status === 'ok'){
        const rows = json.rows;
        if(rows.length === 0){ document.getElementById('queryResult').innerHTML = '<div class="alert alert-info">No rows returned</div>'; return; }
        // build table
        const cols = Object.keys(rows[0]);
        let html = '<div class="table-responsive"><table class="table table-sm table-striped"><thead><tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr></thead><tbody>' + rows.map(r=>'<tr>'+cols.map(c=>`<td>${r[c]===null?'NULL':String(r[c])}</td>`).join('')+'</tr>').join('') + '</tbody></table></div>';
        document.getElementById('queryResult').innerHTML = html;
      } else {
        document.getElementById('queryResult').innerHTML = '<div class="alert alert-danger">'+(json.message||'Error')+'</div>';
      }
    }
  </script>

  <!-- Database modal -->
  <div class="modal fade" id="dbModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Database overview</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body" id="dbModalBody"> </div>
      </div>
    </div>
  </div>

{% endblock %}
